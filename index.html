<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Estado de Guille - Sistema Pro (Shared)</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* --- ESTILOS ORIGINALES DE TU VERSI√ìN FAVORITA (TEST.HTML) --- */
    :root {
      --bg-color: #f4f7f6;
      --container-bg: #ffffff;
      --text-color: #333;
      --header-bg: #f8f9fa;
      --button-bg: #e9ecef;
      --accent: #2196F3;
      --color-trabajo: #a5d6a7;
      --color-franco: #90caf9;
      --color-feriado: #ef9a9a;
      --color-vacaciones: #ce93d8;
      --color-puente: #ffcc80;
      --sidebar-width: 320px;
      --shadow: 0 4px 20px rgba(0,0,0,0.08);
      --radius: 12px;
    }

    body.dark-mode {
      --bg-color: #121212;
      --container-bg: #1e1e1e;
      --text-color: #e0e0e0;
      --header-bg: #2d2d2d;
      --button-bg: #333;
      --shadow: 0 4px 20px rgba(0,0,0,0.4);
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      transition: 0.3s;
      overflow-x: hidden;
    }

    /* PANTALLA DE CARGA */
    #appLoader {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: var(--bg-color); z-index: 5000;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      transition: opacity 0.5s ease;
    }
    .loader-spinner {
      width: 50px; height: 50px; border: 5px solid var(--button-bg);
      border-top: 5px solid var(--accent); border-radius: 50%;
      animation: spin 1s linear infinite; margin-bottom: 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .loader-text { font-weight: 500; color: var(--accent); animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    /* PANTALLA DE LOGIN (NUEVA, INTEGRADA AL ESTILO) */
    #loginScreen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: var(--bg-color); z-index: 6000;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        transition: opacity 0.5s ease;
    }
    .login-box {
        background: var(--container-bg); padding: 40px; border-radius: 20px;
        box-shadow: var(--shadow); text-align: center; max-width: 90%; width: 300px;
    }
    .google-btn {
        background: white; color: #444; border: 1px solid #ddd; padding: 12px;
        border-radius: 30px; font-weight: bold; cursor: pointer; width: 100%;
        display: flex; align-items: center; justify-content: center; gap: 10px;
        margin-top: 20px; font-family: inherit; font-size: 1em;
        transition: 0.2s;
    }
    .google-btn:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.1); transform: scale(1.02); }

    /* MENU Y SIDEBAR */
    #menuToggle {
      position: fixed; top: 20px; left: 20px; z-index: 1000;
      background: var(--accent); color: white; border: none;
      padding: 12px 16px; border-radius: var(--radius); cursor: pointer;
      box-shadow: var(--shadow); font-weight: bold; display: flex; align-items: center; gap: 8px;
    }

    #sidebar {
      position: fixed; top: 0; left: calc(-1 * var(--sidebar-width));
      width: var(--sidebar-width); height: 100%;
      background: var(--container-bg); z-index: 999;
      box-shadow: 4px 0 15px rgba(0,0,0,0.1); transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      padding: 80px 0 20px; box-sizing: border-box; overflow-y: auto;
      display: flex; flex-direction: column;
    }
    #sidebar.open { left: 0; }
    .sidebar-header { padding: 0 25px 20px; border-bottom: 1px solid var(--button-bg); margin-bottom: 10px; }
    .sidebar-header h2 { margin: 0; font-size: 1.4em; color: var(--accent); }

    /* ACORDEON */
    .accordion-item { border-bottom: 1px solid var(--button-bg); }
    .accordion-header {
      width: 100%; padding: 18px 25px; background: none; border: none;
      color: var(--text-color); display: flex; justify-content: space-between;
      align-items: center; cursor: pointer; font-weight: 500; font-size: 1.05em;
      text-align: left; transition: background 0.2s;
    }
    .accordion-header:hover { background: var(--header-bg); }
    .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s; background: var(--header-bg); }
    .accordion-item.active .accordion-content { max-height: 800px; padding: 20px 25px; }

    /* FORMULARIOS Y BOTONES */
    .input-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
    label { font-size: 0.85em; font-weight: 500; opacity: 0.8; }
    input { padding: 10px; border-radius: 8px; border: 1px solid var(--button-bg); background: var(--container-bg); color: var(--text-color); font-size: 1em; }
    
    .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 10px; transition: 0.2s; font-size: 0.95em; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-danger { background: #ff5252; color: white; }
    .btn-secondary { background: var(--button-bg); color: var(--text-color); }

    /* CALENDARIO Y UI */
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 998; display: none; backdrop-filter: blur(2px); }
    .overlay.active { display: block; }
    .main-content { max-width: 900px; margin: 40px auto; padding: 20px; text-align: center; }

    .iframe-wrapper { overflow: hidden; border-radius: var(--radius); box-shadow: var(--shadow); margin: 20px auto 30px; max-width: 500px; background: #000; }
    .iframe-wrapper iframe { width: 100%; height: 280px; border: none; display: block; }

    .calendar-container { background: var(--container-bg); padding: 25px; border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 20px; }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .calendar-header h2 { text-transform: capitalize; margin: 0; font-size: 1.3em; }

    .grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
    .day { aspect-ratio: 1/1; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 500; cursor: pointer; transition: transform 0.1s; color: #1a1a1a; position: relative; }
    .day:hover:not(.day-header) { transform: scale(1.05); }
    .day-header { font-weight: bold; background: var(--header-bg); color: var(--text-color); cursor: default; aspect-ratio: auto; min-height: 30px; }

    /* ESTADOS */
    .trabajo { background: var(--color-trabajo); color: #1b5e20; }
    .franco { background: var(--color-franco); color: #0d47a1; }
    .feriado { background: var(--color-feriado); color: #b71c1c; font-weight: bold; }
    .vacacion { background: var(--color-vacaciones); color: #4a148c; }
    .puente { background: var(--color-puente); color: #e65100; }
    .no-regime { background: #e0e0e0; color: #777; font-style: italic; }
    .hoy { outline: 3px solid var(--text-color); outline-offset: -2px; z-index: 10; }

    /* INFO EXTRA */
    .vacation-badge { background: var(--color-vacaciones); color: #4a148c; padding: 20px; border-radius: 15px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-weight: bold; box-shadow: var(--shadow); }
    .month-info-box { margin-top: 20px; text-align: left; background: var(--container-bg); padding: 20px; border-radius: 15px; box-shadow: var(--shadow); border-left: 6px solid var(--accent); }
    
    .legend { display: flex; justify-content: center; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; font-size: 0.85em; padding: 10px; background: var(--header-bg); border-radius: 10px; }
    .legend-item { display: flex; align-items: center; gap: 6px; }
    .legend-box { width: 14px; height: 14px; border-radius: 3px; border: 1px solid rgba(0,0,0,0.1); }

    /* MODALES */
    #dayModal, #confirmModal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--container-bg); padding: 30px; border-radius: 20px; box-shadow: 0 10px 50px rgba(0,0,0,0.3); z-index: 2000; display: none; width: 300px; text-align: center; }
    #darkModeToggle { position: fixed; top: 20px; right: 20px; z-index: 1000; border: none; background: var(--container-bg); padding: 12px; border-radius: 50%; cursor: pointer; box-shadow: var(--shadow); font-size: 1.2em; }

    /* PERFIL USUARIO */
    .user-profile { margin-top: auto; padding-top: 20px; border-top: 1px solid var(--button-bg); display: flex; align-items: center; gap: 10px; }
    .user-avatar { width: 35px; height: 35px; border-radius: 50%; }

    @media (max-width: 600px) {
      .day { font-size: 0.9em; }
      #sidebar { --sidebar-width: 85%; }
      .vacation-badge { font-size: 0.8em; padding: 15px; }
    }
  </style>
</head>
<body>

  <div id="loginScreen">
    <div class="login-box">
        <h2 style="margin-top:0; color:var(--accent);">Bienvenido</h2>
        <p style="opacity:0.7;">Inicia sesi√≥n para sincronizar el calendario compartido.</p>
        <button id="googleLoginBtn" class="google-btn">
            <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" alt="G" style="width:20px;">
            Entrar con Google
        </button>
        <p id="loginError" style="color:#ff5252; font-size:0.8em; margin-top:15px; display:none;"></p>
    </div>
  </div>

  <div id="appLoader">
    <div class="loader-spinner"></div>
    <div class="loader-text" id="loaderStatus">Cargando...</div>
  </div>

  <div id="appContent" style="display:none;">
      
      <button id="menuToggle">‚ò∞ Centro de Control</button>
      <button id="darkModeToggle">üåô</button>

      <div class="overlay" id="overlay"></div>

      <div id="sidebar">
        <div class="sidebar-header">
            <h2>Panel de Configuraci√≥n</h2>
            <small style="opacity:0.6">Modo Compartido</small>
        </div>

        <div class="accordion-item" id="accRegime">
          <button class="accordion-header">üìÖ R√©gimen Modular</button>
          <div class="accordion-content">
            <div class="input-group">
              <label>D√≠as de Trabajo:</label>
              <input type="number" id="regimeWork" value="4">
            </div>
            <div class="input-group">
              <label>D√≠as de Franco:</label>
              <input type="number" id="regimeOff" value="2">
            </div>
            <div class="input-group">
              <label>Fecha de Inicio:</label>
              <input type="date" id="regimeBaseDate" value="2026-02-11">
            </div>
            <button class="btn btn-primary" id="saveRegime">Agregar Nuevo R√©gimen</button>
            
            <div style="margin-top:20px;">
                <label style="color: var(--accent);">Historial de Cambios:</label>
                <div id="regimeHistoryList"></div>
                <button class="btn btn-danger" style="margin-top:10px; font-size: 0.8em;" id="resetRegimeHistory">Restablecer Todo</button>
            </div>
          </div>
        </div>

        <div class="accordion-item" id="accVac">
          <button class="accordion-header">üèñÔ∏è Vacaciones</button>
          <div class="accordion-content">
            <div class="input-group">
              <label>Total D√≠as Vacaciones:</label>
              <input type="number" id="vacTotal" value="15">
            </div>
            <button class="btn btn-primary" id="saveVacTotal">Guardar Total</button>
          </div>
        </div>

        <div class="accordion-item" id="accSystem">
          <button class="accordion-header">‚öôÔ∏è Sistema</button>
          <div class="accordion-content">
            <button class="btn btn-danger" id="resetAllOverrides">Borrar Cambios Manuales</button>
          </div>
        </div>

        <div class="user-profile">
            <img id="userAvatar" class="user-avatar" src="" alt="">
            <div style="flex:1; overflow:hidden;">
                <div id="userName" style="font-weight:bold; font-size:0.9em; white-space:nowrap;">Usuario</div>
                <div id="syncIndicator" style="font-size:0.75em; color:var(--accent);">‚óè Sincronizado</div>
            </div>
            <button id="logoutBtn" style="background:none; border:none; cursor:pointer; font-size:1.2em;">üö™</button>
        </div>
      </div>

      <div id="dayModal">
        <h3 id="modalDateTitle" style="margin-top:0; color:var(--accent);">D√≠a</h3>
        <button class="btn btn-primary" style="background:var(--color-vacaciones); color:#4a148c;" onclick="setDayOverride('vacacion')">Vacaciones</button>
        <button class="btn btn-secondary" onclick="setDayOverride('trabajo')">Forzar Trabajo</button>
        <button class="btn btn-secondary" onclick="setDayOverride('franco')">Forzar Franco</button>
        <button class="btn btn-danger" onclick="clearDayOverride()">Eliminar Cambio</button>
        <button class="btn btn-secondary" style="margin-top:10px" onclick="closeModal()">Cancelar</button>
      </div>

      <div id="confirmModal">
        <h3 id="confirmTitle" style="color: #ff5252;">¬øConfirmar acci√≥n?</h3>
        <p id="confirmText">¬øEst√°s seguro?</p>
        <div style="display:flex; gap:10px; margin-top:20px;">
          <button class="btn btn-danger" id="confirmBtnYes">S√≠</button>
          <button class="btn btn-secondary" id="confirmBtnNo">No</button>
        </div>
      </div>

      <div class="main-content">
        <h1 id="todayStatus" style="font-size: 1.8em; margin-bottom: 0;">Cargando...</h1>
        
        <div id="mediaContainer"></div>
        
        <div class="calendar-container">
          <div class="legend">
            <div class="legend-item"><div class="legend-box" style="background:var(--color-trabajo)"></div>Trabajo</div>
            <div class="legend-item"><div class="legend-box" style="background:var(--color-franco)"></div>Franco</div>
            <div class="legend-item"><div class="legend-box" style="background:var(--color-feriado)"></div>Feriado</div>
            <div class="legend-item"><div class="legend-box" style="background:var(--color-puente)"></div>Puente</div>
            <div class="legend-item"><div class="legend-box" style="background:var(--color-vacaciones)"></div>Vacaciones</div>
          </div>

          <div class="calendar-header">
            <div class="nav-buttons-inline">
                <button class="btn btn-secondary" style="width:auto; padding: 10px 15px;" id="prevBtn">¬´</button>
                <button class="btn btn-primary" style="width:auto; padding: 10px 20px;" id="goTodayBtn">Hoy</button>
            </div>
            <h2 id="monthLabel">Mes A√±o</h2>
            <button class="btn btn-secondary" style="width:auto; padding: 10px 15px;" id="nextBtn">¬ª</button>
          </div>

          <div class="grid" id="calendarGrid"></div>
        </div>

        <div class="vacation-title">üìä Control de Vacaciones</div>
        <div class="vacation-badge">
          <div>Totales<br><span id="statTotal" style="font-size: 1.5em;">-</span></div>
          <div>Usados<br><span id="statUsed" style="font-size: 1.5em;">-</span></div>
          <div>Restantes<br><span id="statRemaining" style="font-size: 1.5em;">-</span></div>
        </div>
        
        <div class="month-info-box">
            <h3 style="margin-top:0; font-size: 1.1em;">üìÖ Detalle del Mes:</h3>
            <div id="feriadosList"></div>
        </div>
      </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- CONFIGURACI√ìN FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyCjpgBTX_LfMirpu7jNuCMqZ6dTr-DC22Q",
      authDomain: "calendario-guille.firebaseapp.com",
      projectId: "calendario-guille",
      storageBucket: "calendario-guille.firebasestorage.app",
      messagingSenderId: "56762114940",
      appId: "1:56762114940:web:0b437eaa436952580ffaf9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // RUTA COMPARTIDA (CLAVE PARA MODO ESPEJO)
    const SHARED_PATH = "familia_guille_pro";

    const urls = {
      trabajo: "https://drive.google.com/file/d/1fE2hdLZCNAcs40PMZ9gNrCiXZQA5EJLW/preview?embedded=true",
      franco: "https://drive.google.com/file/d/1fGs9mFCGeJ9_gCBBRstFJKvbIkax65Wl/preview?embedded=true"
    };

    let currentUser = null;
    let config = { regimeHistory: [{ start: '2025-04-07', work: 4, off: 2 }], vacations: { total: 15 } };
    let overrides = {}; 

    const feriados2026 = [
      { f: '2026-01-01', n: 'A√±o Nuevo', t: 'oficial' },
      { f: '2026-02-16', n: 'Carnaval', t: 'oficial' },
      { f: '2026-02-17', n: 'Carnaval', t: 'oficial' },
      { f: '2026-03-23', n: 'Puente Tur√≠stico', t: 'puente' },
      { f: '2026-03-24', n: 'D√≠a de la Memoria', t: 'oficial' },
      { f: '2026-04-02', n: 'Malvinas', t: 'oficial' },
      { f: '2026-04-03', n: 'Viernes Santo', t: 'oficial' },
      { f: '2026-05-01', n: 'D√≠a del Trabajador', t: 'oficial' },
      { f: '2026-05-25', n: 'Revoluci√≥n de Mayo', t: 'oficial' },
      { f: '2026-06-15', n: 'G√ºemes (Tr.)', t: 'oficial' },
      { f: '2026-06-20', n: 'D√≠a de la Bandera', t: 'oficial' },
      { f: '2026-07-09', n: 'D√≠a de la Independencia', t: 'oficial' },
      { f: '2026-07-10', n: 'Puente Tur√≠stico', t: 'puente' },
      { f: '2026-08-17', n: 'San Mart√≠n (Tr.)', t: 'oficial' },
      { f: '2026-10-12', n: 'Diversidad Cultural (Tr.)', t: 'oficial' },
      { f: '2026-11-23', n: 'Soberan√≠a Nacional (Tr.)', t: 'oficial' },
      { f: '2026-12-07', n: 'Puente Tur√≠stico', t: 'puente' },
      { f: '2026-12-08', n: 'Inmaculada Concepci√≥n', t: 'oficial' },
      { f: '2026-12-25', n: 'Navidad', t: 'oficial' }
    ];

    let currentViewDate = new Date();
    let selectedDateStr = null;
    let pendingAction = null;

    // --- ACCORDION ---
    document.querySelectorAll('.accordion-header').forEach(header => {
      header.addEventListener('click', () => {
        const item = header.parentElement;
        const isActive = item.classList.contains('active');
        document.querySelectorAll('.accordion-item').forEach(i => i.classList.remove('active'));
        if (!isActive) item.classList.add('active');
      });
    });

    // --- AUTHENTICATION & SYNC ---
    
    // Bot√≥n Google
    document.getElementById('googleLoginBtn').onclick = async () => {
        try {
            await signInWithPopup(auth, provider);
        } catch (e) {
            console.error(e);
            const errDiv = document.getElementById('loginError');
            errDiv.style.display = 'block';
            errDiv.textContent = "Error: " + e.message;
        }
    };

    // Bot√≥n Salir
    document.getElementById('logoutBtn').onclick = () => signOut(auth);

    // Estado Auth
    onAuthStateChanged(auth, (user) => {
        const loader = document.getElementById('appLoader');
        const loginScreen = document.getElementById('loginScreen');
        const appContent = document.getElementById('appContent');

        if (user) {
            currentUser = user;
            // UI Update
            document.getElementById('userName').textContent = user.displayName || "Usuario";
            if (user.photoURL) document.getElementById('userAvatar').src = user.photoURL;

            // Transiciones
            loginScreen.style.opacity = '0';
            setTimeout(() => {
                loginScreen.style.display = 'none';
                appContent.style.display = 'block';
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 500);
            }, 500);

            // IMPORTANTE: Render inicial para que no se quede en "Calculando..."
            render(); 
            // Iniciar escucha de datos compartidos
            startLiveSync();

        } else {
            // No user
            currentUser = null;
            appContent.style.display = 'none';
            loginScreen.style.display = 'flex';
            loginScreen.style.opacity = '1';
            loader.style.display = 'none';
        }
    });

    // SYNC COMPARTIDA
    function startLiveSync() {
        // Escuchar CONFIG
        onSnapshot(doc(db, 'calendario_compartido', SHARED_PATH, 'data', 'settings'), (snap) => {
            if (snap.exists()) {
                const data = snap.data();
                if (data.regimeHistory) config.regimeHistory = data.regimeHistory;
                if (data.vacations) config.vacations = data.vacations;
                updateHistoryUI();
                render(); // Actualizar calendario cuando llegan datos
            } else {
                saveConfig(); // Crear doc si no existe
            }
        });

        // Escuchar OVERRIDES
        onSnapshot(doc(db, 'calendario_compartido', SHARED_PATH, 'data', 'overrides'), (snap) => {
            if (snap.exists()) {
                overrides = snap.data();
                render(); // Actualizar calendario cuando llegan cambios
            }
        });
    }

    // SAVING
    async function saveConfig() {
        if (!currentUser) return;
        document.getElementById('syncIndicator').textContent = "üîÑ Guardando...";
        await setDoc(doc(db, 'calendario_compartido', SHARED_PATH, 'data', 'settings'), config);
        document.getElementById('syncIndicator').textContent = "‚óè Sincronizado";
    }

    async function saveOverrides() {
        if (!currentUser) return;
        document.getElementById('syncIndicator').textContent = "üîÑ Guardando...";
        await setDoc(doc(db, 'calendario_compartido', SHARED_PATH, 'data', 'overrides'), overrides);
        document.getElementById('syncIndicator').textContent = "‚óè Sincronizado";
    }

    // --- HELPER FUNCTIONS ---
    window.closeModal = () => {
        document.getElementById('confirmModal').style.display = 'none';
        document.getElementById('dayModal').style.display = 'none';
        document.getElementById('overlay').classList.remove('active');
        pendingAction = null;
    };

    function customConfirm(text, action) {
        document.getElementById('confirmText').textContent = text;
        document.getElementById('confirmModal').style.display = 'block';
        document.getElementById('overlay').classList.add('active');
        pendingAction = action;
    }

    document.getElementById('confirmBtnYes').addEventListener('click', async () => {
        if (pendingAction) await pendingAction();
        window.closeModal();
    });

    document.getElementById('confirmBtnNo').addEventListener('click', () => window.closeModal());

    // --- MODAL LOGIC EXPOSED TO WINDOW FOR ONCLICK ---
    window.openModal = (dateStr) => {
      selectedDateStr = dateStr;
      const partes = dateStr.split('-');
      document.getElementById('modalDateTitle').textContent = `D√≠a: ${partes[2]}/${partes[1]}/${partes[0]}`;
      document.getElementById('dayModal').style.display = 'block';
      document.getElementById('overlay').classList.add('active');
    };

    window.setDayOverride = async (type) => {
      overrides[selectedDateStr] = type;
      render(); // Optimistic UI
      window.closeModal();
      await saveOverrides();
    };

    window.clearDayOverride = async () => {
      delete overrides[selectedDateStr];
      render(); // Optimistic UI
      window.closeModal();
      await saveOverrides();
    };

    // --- CALENDAR LOGIC (MATH) ---
    window.removeRegime = (idx) => {
        customConfirm("¬øSeguro que quieres borrar este r√©gimen?", async () => {
            config.regimeHistory.splice(idx, 1);
            await saveConfig();
        });
    };

    function updateHistoryUI() {
        const list = document.getElementById('regimeHistoryList');
        list.innerHTML = '';
        const indexedHistory = config.regimeHistory.map((reg, idx) => ({ ...reg, originalIndex: idx }));
        const sorted = indexedHistory.sort((a, b) => new Date(b.start) - new Date(a.start));
        
        sorted.forEach((reg) => {
            const div = document.createElement('div');
            div.className = 'history-item';
            const infoDiv = document.createElement('div');
            infoDiv.innerHTML = `<strong>${reg.start.split('-').reverse().join('/')}</strong><br>${reg.work}x${reg.off}`;
            div.appendChild(infoDiv);
            if (config.regimeHistory.length > 1) {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger';
                deleteBtn.style.cssText = 'width:auto; padding:5px 10px; margin:0;';
                deleteBtn.textContent = 'üóëÔ∏è';
                deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); removeRegime(reg.originalIndex); });
                div.appendChild(deleteBtn);
            }
            list.appendChild(div);
        });
    }

    function getActiveRegimeForDate(date) {
        const sorted = [...config.regimeHistory].sort((a, b) => new Date(b.start) - new Date(a.start));
        return sorted.find(r => {
            const startDate = new Date(r.start + 'T00:00:00');
            return startDate <= date;
        });
    }

    function render() {
      const grid = document.getElementById('calendarGrid');
      const monthLabel = document.getElementById('monthLabel');
      const statusH1 = document.getElementById('todayStatus');
      const mediaContainer = document.getElementById('mediaContainer');
      const feriadosList = document.getElementById('feriadosList');
      const statsTotal = document.getElementById('statTotal');
      const statsUsed = document.getElementById('statUsed');
      const statsRem = document.getElementById('statRemaining');
      
      grid.innerHTML = '';
      const year = currentViewDate.getFullYear();
      const month = currentViewDate.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      
      monthLabel.textContent = new Intl.DateTimeFormat('es-ES', { month: 'long', year: 'numeric' }).format(currentViewDate);
      
      ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'].forEach(d => {
        const el = document.createElement('div');
        el.className = 'day day-header';
        el.textContent = d;
        grid.appendChild(el);
      });

      for(let i=0; i<firstDay.getDay(); i++) grid.appendChild(document.createElement('div'));

      let usedVacDays = 0;
      Object.values(overrides).forEach(v => { if(v === 'vacacion') usedVacDays++; });

      const eventosDelMes = [];

      for(let d=1; d<=lastDay.getDate(); d++) {
        const date = new Date(year, month, d);
        date.setHours(0,0,0,0);
        const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const dayEl = document.createElement('div');
        dayEl.className = 'day';
        dayEl.textContent = d;

        const activeRegime = getActiveRegimeForDate(date);
        let finalType = 'no-regime';

        if (activeRegime) {
            const baseDate = new Date(activeRegime.start + 'T00:00:00');
            baseDate.setHours(0,0,0,0);
            const diffMs = date.getTime() - baseDate.getTime();
            const diffDays = Math.round(diffMs / 86400000);
            const cycleTotal = activeRegime.work + activeRegime.off;
            const cyclePos = ((diffDays % cycleTotal) + cycleTotal) % cycleTotal;
            finalType = cyclePos < activeRegime.work ? 'trabajo' : 'franco';
        }
        
        if (overrides[dateStr]) finalType = overrides[dateStr];

        const feriado = feriados2026.find(f => f.f === dateStr);
        if (feriado && finalType !== 'vacacion') {
          dayEl.classList.add(feriado.t === 'puente' ? 'puente' : 'feriado');
          const esTrabajo = finalType === 'trabajo';
          const statusStr = esTrabajo ? '<span style="color:#b71c1c; font-weight:bold;">üö® Trabajas</span>' : '<span style="color:#0d47a1; font-weight:bold;">ü•≥ Franco</span>';
          eventosDelMes.push(`<strong>${d}/${month + 1}:</strong> ${feriado.n} - ${statusStr}`);
        } else {
          dayEl.classList.add(finalType);
        }

        if (date.toDateString() === new Date().toDateString()) {
          dayEl.classList.add('hoy');
          const esTrabajo = finalType === 'trabajo';
          statusH1.textContent = esTrabajo ? 'Guille est√° trabajando üë∑' : (finalType === 'vacacion' ? 'Guille est√° de vacaciones üèñÔ∏è' : 'Guille est√° de franco üéâ');
          mediaContainer.innerHTML = `<div class="iframe-wrapper"><iframe src="${esTrabajo ? urls.trabajo : urls.franco}" allow="autoplay"></iframe></div>`;
        }
        dayEl.onclick = () => window.openModal(dateStr);
        grid.appendChild(dayEl);
      }

      feriadosList.innerHTML = eventosDelMes.length > 0 ? eventosDelMes.join('<br>') : "Sin eventos especiales este mes.";
      statsTotal.textContent = config.vacations.total;
      statsUsed.textContent = usedVacDays;
      statsRem.textContent = Math.max(0, config.vacations.total - usedVacDays);
    }

    document.getElementById('saveRegime').onclick = async () => {
      const work = parseInt(document.getElementById('regimeWork').value);
      const off = parseInt(document.getElementById('regimeOff').value);
      const start = document.getElementById('regimeBaseDate').value;
      config.regimeHistory.push({ start, work, off });
      await saveConfig();
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('overlay').classList.remove('active');
    };

    document.getElementById('resetRegimeHistory').onclick = async () => {
        customConfirm("¬øBorrar todo el historial y volver al inicio?", async () => {
            config.regimeHistory = [{ start: '2025-04-07', work: 4, off: 2 }];
            await saveConfig();
        });
    }

    document.getElementById('saveVacTotal').onclick = async () => {
      config.vacations.total = parseInt(document.getElementById('vacTotal').value);
      await saveConfig();
      const btn = document.getElementById('saveVacTotal');
      btn.textContent = "‚úÖ Guardado";
      setTimeout(() => btn.textContent = "Guardar Total", 2000);
    };

    document.getElementById('resetAllOverrides').onclick = async () => {
      customConfirm("¬øBorrar todos los cambios manuales?", async () => {
        overrides = {};
        await saveOverrides();
      });
    };

    document.getElementById('menuToggle').onclick = () => {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('overlay');
      sidebar.classList.toggle('open');
      overlay.classList.toggle('active');
    };

    document.getElementById('overlay').onclick = () => {
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('overlay').classList.remove('active');
      window.closeModal();
    };

    document.getElementById('prevBtn').onclick = () => { currentViewDate.setMonth(currentViewDate.getMonth() - 1); render(); };
    document.getElementById('nextBtn').onclick = () => { currentViewDate.setMonth(currentViewDate.getMonth() + 1); render(); };
    document.getElementById('goTodayBtn').onclick = () => { currentViewDate = new Date(); render(); };

    document.getElementById('darkModeToggle').onclick = () => {
      const isDark = document.body.classList.toggle('dark-mode');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    };

    if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
    
  </script>
</body>
</html>
